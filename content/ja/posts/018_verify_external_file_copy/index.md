+++
date = '2025-05-26T18:30:36+09:00'
draft = false
title = '外部デバイスへのファイルコピー検証'
+++


# Macから外部デバイスへファイルコピー時のトラブルと解決手順まとめ【差分検出・resource fork・findコマンド活用】

Macから外部デバイスに大量のファイル（写真・動画）をコピーする際、**コピー中断→再実行→ファイル数不一致**という問題に直面しました。本記事では、その問題をどうやって特定・解決したかを紹介します。

---

## 背景：コピー中にMacを閉じてしまった

GoProで撮影した**MP4とJPGファイル130個**を、Mac（macOS）から外部デバイス（USBメモリ）にコピー中、**途中でMacを閉じてしまい**、コピーが中断されました。

その後、コピーを再実行したものの、**すぐに停止してしまい**ました。コピー先に**同じ名前のファイルがあるためスキップされた可能性**がありますが、果たして**すべてのファイルが正しくコピーされたのかは不明**なままでした。

---

## 目的と制約

- **目的**：外部デバイスへのコピーが完全か確認した上で、Mac側の元ファイルを削除したい

- **制約**：

    - 中断の影響で**コピー漏れがあるかもしれない**

    - 外部デバイスには**一時ファイルや重複ファイル**が混じっている可能性

    - データの欠落は絶対に避けたい


---

## ステップ1：ファイル数を確認

まずは**外部デバイス側のファイル数**をチェックしました。
しかし、単純に `find` コマンドを使うと、macOS特有の**不可視ファイル（`.Spotlight-V100`, `.Trashes`, `.fseventsd`）**も含まれてしまいます。

### 使用コマンド（除外付き）:

``` bash
find /Volumes/GoPro2022 \( -path "*/.Spotlight-V100" -o -path "*/.Trashes" -o -path "*/.fseventsd" \) -prune -o -type f \( -iname "*.jpg" -o -iname "*.mp4" \) -print | wc -l

```

- `-prune`：除外対象ディレクトリを探索しない

- `-type f`：ファイルのみ対象

- `-iname`：大文字・小文字を無視して拡張子でフィルター


### 結果：

`244`

！？元ファイルは130個のはず…。この時点でファイル数が大きく異なる理由は不明でした。

---

## ステップ2：Resource Forkファイルの存在を確認

macOSはFinder経由のコピーで**「Resource Fork」（._で始まるファイル）**を自動的に作成することがあります。これは、Windowsや非Mac環境では「ゴミファイル」と誤解されがちですが、実は**メタデータやFinder情報**を保存している隠しファイルです。

### 確認コマンド：

``` bash
find /Volumes/GoPro2022 -type f -name "._*" | wc -l

```



結果：`115`
→ **129（正常ファイル数）＋115（resource fork）≒244**

この時点で、**ファイル数のズレはResource Forkが原因**だとわかりました。

---

## ステップ3：ファイル名の差分を精査

`find` で抽出した**ファイル名（basenameのみ）**を比較することで、コピー漏れを特定できます。

### ファイル名抽出用コマンド

#### 外部デバイス側：

``` bash
find /Volumes/GoPro2022 \( -path "*/.Spotlight-V100" -o -path "*/.Trashes" -o -path "*/.fseventsd" \) -prune -o -type f ! -name "._*" \( -iname "*.jpg" -o -iname "*.mp4" \) -print0 | xargs -0 -n 1 basename | sort > external_files.txt
```


#### Mac側：

``` bash
find /Users/machine/Documents/HERO7_BLACK/2022/ -type f ! -name "._*" \( -iname "*.jpg" -o -iname "*.mp4" \) -print0 | xargs -0 -n 1 basename | sort > mac_files.txt

```



### 差分の比較

``` bash
comm -23 mac_files.txt external_files.txt > missing_files.txt

```


結果：**1ファイルがmissing**

---

## ステップ4：原因の特定

**犯人は「手動操作ミス」**でした。最初のコピー時に1ファイルを選択し忘れていたようです。
`comm`の結果がゼロだった場合、ファイル名ベースでは**全て一致していた**ことになります。

---

## 学習ポイントまとめ

|テーマ|ポイント|
|---|---|
|**Resource Forkとは**|macOS独自のメタ情報。USBコピー時に._付きファイルが生成される。不要なら削除可能。|
|**`find`の使い方**|`-prune`で不要なディレクトリ除外、`-iname`で拡張子フィルタ、`-print0 + xargs -0`で空白対応。|
|**`comm`で差分抽出**|ソート済みファイルに対し差分を行う便利なツール。ファイル名のみの比較に向く。|
|**コピー検証手順**|ファイル名のリストアップ→差分検出→該当ファイルの再コピーで対応可能。|

---

## 結論と教訓

- **Resource Forkによる混乱を避けるには、ターミナルベースでの検証が有効**

- ファイル名単位の差分検出は、正確なコピー検証に役立つ

- **手動操作ミス（ドラッグ漏れ）は意外と多い。検証フローを用意すべし**


---

## おまけ：不要なリソースフォークを削除するには？

``` bash
find /Volumes/GoPro2022 -type f -name "._*" -delete

```


**※注意：Finderで再コピーすると再生成される可能性あり。rsyncなどの使用を検討しても良いでしょう。**

---

この一件を通じて、macOS特有のファイル構造や、UNIX系コマンドの応用について理解が深まりました。同じようなケースで困っている方の参考になれば幸いです。

---

※実体験に基づいているため、環境によって異なる挙動がある可能性があります。作業前には必ずバックアップを取ってください。